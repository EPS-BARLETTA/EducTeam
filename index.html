<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EduTeam ‚Ä¢ Suivi collaboratif (Lite)</title>
  <style>
    /* ===== UI LITE ===== */
    :root{--bg:#f6f7fb;--card:#fff;--text:#111;--muted:#6b7280;--pri:#2563eb;--ok:#16a34a;--warn:#f59e0b;--border:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:auto;padding:14px}
    .hidden{display:none}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .logo{display:inline-flex;gap:8px;align-items:center}
    .logo i{width:28px;height:28px;display:grid;place-items:center;border-radius:10px;background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;font-weight:900}
    .badge{background:#eef2ff;color:#3730a3;padding:4px 8px;border-radius:12px;font-size:12px}
    .toolbar{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .btn,button{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:var(--card);padding:9px 13px;border-radius:12px;cursor:pointer}
    .primary{background:var(--pri);color:#fff;border-color:transparent}
    .success{background:var(--ok);color:#fff;border-color:transparent}
    input[type=file]{display:none}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:14px;align-items:start}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.05)}
    .card .content{padding:14px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .kpi{border:1px solid var(--border);border-radius:12px;padding:10px}
    .kpi .v{font-size:20px;font-weight:800}
    .bar{height:8px;border-radius:999px;background:#eef2f7;overflow:hidden;margin-top:6px}
    .fill{height:100%;width:0}
    .fill.ok{background:linear-gradient(90deg,#10b981,#22c55e)}
    .fill.warn{background:linear-gradient(90deg,#f59e0b,#f97316)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{padding:8px 10px;font-size:12px;color:var(--muted);text-align:left;text-transform:uppercase}
    tbody tr{background:var(--card);border:1px solid var(--border)}
    td{padding:10px 10px}
    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .pill.ok{background:#ecfdf5;color:#065f46}
    .pill.att{background:#fff7ed;color:#9a3412}
    .empty{padding:14px;border:1px dashed var(--border);border-radius:12px;text-align:center;color:var(--muted)}
    /* Cover */
    .cover{min-height:100dvh;display:grid;place-items:center;padding:32px}
    .hero{max-width:900px;width:100%;background:linear-gradient(180deg,rgba(255,255,255,.7),rgba(255,255,255,.55));border:1px solid var(--border);border-radius:24px;box-shadow:0 10px 60px rgba(0,0,0,.08);padding:24px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border)}
    .search{display:flex;gap:8px;margin-top:8px}
    .search input,.search select{flex:1;padding:10px;border:1px solid var(--border);border-radius:10px}
    .footer{padding:16px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>

<section class="cover" id="cover">
  <div class="hero">
    <div class="logo" style="margin-bottom:8px"><i>ET</i><div>
      <h2 style="margin:0">EduTeam</h2>
      <div class="muted">Suivi collaboratif ¬∑ PP & √©quipe √©ducative</div>
    </div></div>
    <div class="chips">
      <span class="chip">Import CSV</span><span class="chip">Observations</span>
      <span class="chip">Fil d'√©quipe</span><span class="chip">Exports CSV / PDF</span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="primary" onclick="UI.enterApp()">üöÄ Entrer</button>
      <label class="btn"><input type="file" id="csvInputCover" accept=".csv">üì• Importer CSV</label>
      <button class="success" onclick="UI.demoFill()">‚ú® D√©mo</button>
      <button onclick="Mail.openCompose()">‚úâÔ∏è Mail</button>
      <button onclick="UI.showHelp()">‚ùì Aide</button>
    </div>
    <div class="footer">RGPD : donn√©es <b>locales</b> sur cet appareil (export/mail au besoin).</div>
  </div>
</section>

<header id="appHeader" class="hidden">
  <div class="wrap">
    <div class="bar">
      <div class="logo"><i>ET</i><b>EduTeam</b></div>
      <span class="badge" id="className">Classe: (non d√©finie)</span>
      <span class="badge" id="counts">0 √©l√®ves ¬∑ 0 obs</span>
      <span class="right" id="userBadge" style="margin-left:auto;color:#6b7280"></span>
    </div>
    <div class="toolbar">
      <button onclick="UI.showCover()">üè† Accueil</button>
      <label class="btn"><input type="file" id="csvInput" accept=".csv">üì• Import CSV</label>
      <button class="success" id="addStudentBtn">‚ûï √âl√®ve</button>
      <button class="primary" id="exportObsCsv">üì§ Export CSV obs</button>
      <button id="printBtn">üñ®Ô∏è PDF</button>
      <button onclick="Mail.openCompose()">‚úâÔ∏è Mail</button>
      <button id="helpBtn">‚ùì Aide</button>
      <input id="quickSearch" placeholder="Rechercher (nom, pr√©nom)" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
    </div>
  </div>
</header>

<main id="appMain" class="wrap grid hidden">
  <section class="card">
    <div class="content">
      <h3 style="margin:0 0 6px">Synth√®se</h3>
      <div class="kpis">
        <div class="kpi"><div class="v" id="kpiEleves">0</div><div class="t">√âl√®ves</div></div>
        <div class="kpi"><div class="v" id="kpiObs">0</div><div class="t">Observations</div></div>
        <div class="kpi"><div class="v" id="kpiWarn">0</div><div class="t">‚ö†Ô∏è Attention</div><div class="bar"><div class="fill warn" id="barWarn"></div></div></div>
        <div class="kpi"><div class="v" id="kpiOk">0</div><div class="t">‚úÖ OK</div><div class="bar"><div class="fill ok" id="barOk"></div></div></div>
      </div>
      <div class="search">
        <select id="filterCategorie">
          <option value="">Cat√©gorie</option><option>Travail</option><option>Comportement</option><option>Sant√©</option><option>Social</option><option>Orientation</option><option>Autre</option>
        </select>
        <select id="filterEtat">
          <option value="">√âtat</option><option value="attention">‚ö†Ô∏è Attention</option><option value="ok">‚úÖ OK</option>
        </select>
        <button id="resetFilters">R√©initialiser</button>
      </div>

      <h4 style="margin:12px 0 6px">Fil d'√©quipe</h4>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <input id="feedAuthor" placeholder="Auteur" style="max-width:200px;padding:9px;border:1px solid #e5e7eb;border-radius:10px">
        <input id="feedText" placeholder="Message interne" style="flex:1;padding:9px;border:1px solid #e5e7eb;border-radius:10px">
        <button class="primary" onclick="Feed.post()">Envoyer</button>
        <button onclick="Feed.copyDigest()">üìã Copier</button>
      </div>
      <div id="feedList" class="empty">Aucun message pour le moment.</div>
    </div>
  </section>

  <section class="card" style="overflow:auto">
    <div class="content">
      <h3 style="margin:0 0 6px">√âl√®ves</h3>
      <table>
        <thead><tr><th>Nom</th><th>Pr√©nom</th><th>Sexe</th><th>Obs</th><th>Derni√®re</th><th>√âtat</th></tr></thead>
        <tbody id="studentsBody"><tr><td colspan="6" class="empty">Importez un CSV ou ajoutez un √©l√®ve.</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<div class="footer wrap">Astuce : utilisez ‚úâÔ∏è Mail pour partager un bilan aux coll√®gues directement depuis l'app.</div>

<div class="drawer hidden" id="drawer" style="position:fixed;inset:0;background:rgba(0,0,0,.35)">
  <div style="position:absolute;right:0;top:0;height:100%;width:min(560px,100%);background:#fff;display:flex;flex-direction:column">
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e5e7eb">
      <div><b id="drawerTitle"></b><div class="muted" id="drawerSub"></div></div>
      <div><button class="btn" onclick="UI.closeDrawer()">‚úñÔ∏è Fermer</button></div>
    </div>
    <div class="wrap" style="overflow:auto;flex:1">
      <div class="content" style="padding:0">
        <div class="obs-form" style="display:grid;gap:8px">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <select id="obsCategorie">
              <option>Travail</option><option>Comportement</option><option>Sant√©</option><option>Social</option><option>Orientation</option><option>Autre</option>
            </select>
            <select id="obsEtat"><option value="ok">‚úÖ OK</option><option value="attention">‚ö†Ô∏è Attention</option></select>
            <input id="obsAuteur" placeholder="Auteur"/><input id="obsDate" type="date"/>
          </div>
          <textarea id="obsTexte" placeholder="Saisir l'observation‚Ä¶" style="min-height:110px;padding:10px;border:1px solid #e5e7eb;border-radius:10px"></textarea>
          <div style="display:flex;gap:8px">
            <button class="primary" onclick="UI.addObservation()">‚ûï Ajouter</button>
            <button onclick="UI.copyStudentReport()">üìã Copier bilan</button>
            <button class="btn" onclick="UI.deleteStudent()">üóëÔ∏è Supprimer √©l√®ve</button>
          </div>
        </div>
        <div id="obsList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== STATE ===== */
const LS='eduteam_lite_v2';
window.state=load()||{classe:'(non d√©finie)',eleves:[],observations:{},feed:[],users:{current:{name:'',role:'pp'}}};
let currentId=null;
function save(){localStorage.setItem(LS,JSON.stringify(state))}
function load(){try{return JSON.parse(localStorage.getItem(LS))}catch(e){return null}}
function uid(){return'e_'+Math.random().toString(36).slice(2,10)}

/* ===== CSV ===== */
window.CSV={
  parse(t){
    const r=[]; let row=[]; let cur=''; let q=false;
    for(let i=0;i<t.length;i++){
      const c=t[i];
      if(c==='"'){ if(q && t[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
      else if(c===',' && !q){ row.push(cur.trim()); cur=''; }
      else if((c==='\\n'||c==='\\r') && !q){
        if(cur!==''||row.length){ row.push(cur.trim()); r.push(row); row=[]; cur=''; }
      } else { cur+=c; }
    }
    if(cur!==''||row.length){ row.push(cur.trim()); r.push(row); }
    return r.filter(x=>x.length&&x.some(v=>v!==''))
  },
  to(rows){return rows.map(r=>r.map(x=>/[,"\\n]/.test(String(x))?'"'+String(x).replace(/"/g,'""')+'"':String(x)).join(',')).join('\\n')}
};
function fDate(ts){const d=new Date(ts);return d.toLocaleDateString('fr-FR',{year:'2-digit',month:'2-digit',day:'2-digit'})}
function lastDateFor(id){const a=state.observations[id]||[];return a.length?fDate(a[a.length-1].ts):''}
function countObs(id){return(state.observations[id]||[]).length}
function statusFor(id){const a=state.observations[id]||[];return a.length?(a[a.length-1].etat||'ok'):'ok'}

/* ===== FEED ===== */
window.Feed={
  post(){
    const t=document.getElementById('feedText').value.trim(); if(!t) return;
    const a=(document.getElementById('feedAuthor').value.trim()||state.users.current.name||'Anonyme');
    state.feed.unshift({ts:Date.now(),author:a,text:t}); save(); UI.renderFeed();
    document.getElementById('feedText').value='';
  },
  render(){UI.renderFeed()},
  copyDigest(){
    const L=['[Fil] '+(state.classe||''),''];
    state.feed.slice(0,20).forEach(m=>L.push('‚Ä¢ '+new Date(m.ts).toLocaleString('fr-FR')+' ‚Äî '+m.author+': '+m.text));
    navigator.clipboard.writeText(L.join('\\n')); alert('Fil copi√©.');
  }
};
function escapeHtml(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}

/* ===== MAIL ===== */
window.Mail={
  openCompose(){
    const c=prompt('Type de mail ?\\n1 = Bilan de classe\\n2 = √âl√®ves ‚ö†Ô∏è\\n3 = √âl√®ve ouvert');
    if(!c) return; if(c==='1') Mail.classDigest(); else if(c==='2') Mail.attentionOnly(); else if(c==='3') Mail.currentStudent();
  },
  _mailto(S,B){location.href='mailto:?subject='+encodeURIComponent(S)+'&body='+encodeURIComponent(B)},
  classDigest(){
    const att=state.eleves.filter(e=>statusFor(e.id)==='attention'); const ok=state.eleves.length-att.length;
    const lines=['Bilan '+(state.classe||'')+' ‚Äî '+new Date().toLocaleDateString('fr-FR'),'','√âl√®ves: '+state.eleves.length,'Observations: '+Object.values(state.observations).reduce((a,b)=>a+b.length,0),'‚úÖ OK: '+ok+'  ‚Ä¢  ‚ö†Ô∏è Attention: '+att.length,''];
    if(att.length){
      lines.push('√âl√®ves √† suivre :');
      att.sort((a,b)=>a.nom.localeCompare(b.nom,'fr',{sensitivity:'base'})).forEach(e=>lines.push(' ‚Ä¢ '+e.nom+' '+e.prenom+' ('+(e.sexe||'-')+') ‚Äî Derni√®re: '+(lastDateFor(e.id)||'-')));
      lines.push('');
    }
    lines.push('Envoy√© depuis EduTeam (Lite)');
    Mail._mailto('Bilan '+(state.classe||'')+' ‚Äî '+new Date().toLocaleDateString('fr-FR'),lines.join('\\n'));
  },
  attentionOnly(){
    const att=state.eleves.filter(e=>statusFor(e.id)==='attention'); if(!att.length){alert('Aucun √©l√®ve en ‚ö†Ô∏è');return}
    const L=['Suivi ‚Äî Attention ('+(state.classe||'')+')',''];
    att.sort((a,b)=>a.nom.localeCompare(b.nom,'fr',{sensitivity:'base'})).forEach(e=>{
      const obs=(state.observations[e.id]||[]).slice(-3);
      L.push('‚Ä¢ '+e.nom+' '+e.prenom+' ('+(e.sexe||'-')+')'); obs.forEach(o=>L.push('   - ['+o.categorie+' ‚Ä¢ '+o.etat+'] '+new Date(o.ts).toLocaleDateString('fr-FR')+' ‚Ä¢ '+(o.auteur||'‚Äî')+' : '+o.texte)); L.push('');
    });
    Mail._mailto('Suivi ‚Äî attention '+(state.classe||''),L.join('\\n'));
  },
  currentStudent(){
    if(!currentId){alert('Ouvrez une fiche.');return}
    const e=state.eleves.find(x=>x.id===currentId); const arr=state.observations[currentId]||[];
    const L=['Bilan '+e.prenom+' '+e.nom+' ('+e.classe+')',''];
    arr.forEach(o=>L.push('['+o.categorie+' ‚Ä¢ '+(o.etat==='attention'?'‚ö†Ô∏è':'‚úÖ')+' ‚Ä¢ '+new Date(o.ts).toLocaleDateString('fr-FR')+' ‚Ä¢ '+(o.auteur||'‚Äî')+'] '+o.texte));
    Mail._mailto('Bilan '+e.prenom+' '+e.nom+' ‚Äî '+e.classe, L.join('\\n'));
  }
};

/* ===== IMPORT/EXPORT ===== */
window.Import={
  handleCsv(ev){
    const f=ev.target.files[0]; if(!f){UI.enterApp();return}
    const rd=new FileReader(); rd.onload=()=>Import.fromText(rd.result); rd.readAsText(f,'utf-8'); ev.target.value='';
  },
  fromText(text){
    const rows=CSV.parse(text); if(!rows.length){alert('CSV vide');return}
    const H=rows[0].map(h=>h.toLowerCase());
    const iNom=H.findIndex(h=>/nom/.test(h)); const iPre=H.findIndex(h=>/pr[e√©]nom/.test(h));
    const iCla=H.findIndex(h=>/class/.test(h)); const iSex=H.findIndex(h=>/sexe|sex/.test(h));
    if(iNom<0||iPre<0){alert('En-t√™tes requis: Nom, Pr√©nom');return}
    const added=[];
    for(let i=1;i<rows.length;i++){
      const r=rows[i]; if(!r.length) continue;
      const nom=r[iNom]||''; const prenom=r[iPre]||''; if(!(nom||prenom)) continue;
      const classe=r[iCla]||state.classe||''; const sexe=r[iSex]||'';
      const id=uid(); state.eleves.push({id,nom,prenom,classe,sexe,_ts:Date.now()}); added.push(prenom+' '+nom);
      if(!state.classe&&classe) state.classe=classe;
    }
    save(); UI.refreshAll(); alert(added.length+' √©l√®ves import√©s.'); UI.enterApp();
  }
};
window.Export={
  obsCsv(){
    const rows=[["Classe","Nom","Pr√©nom","Sexe","Date","Heure","Cat√©gorie","√âtat","Auteur","Observation"]];
    state.eleves.forEach(e=>{
      const arr=state.observations[e.id]||[];
      if(!arr.length){rows.push([e.classe||'',e.nom||'',e.prenom||'',e.sexe||'','','','','','','']);return}
      arr.forEach(o=>{
        const d=new Date(o.ts);
        rows.push([e.classe||'',e.nom||'',e.prenom||'',e.sexe||'',d.toLocaleDateString('fr-FR'),d.toLocaleTimeString('fr-FR'),o.categorie,o.etat,o.auteur||'',o.texte])
      })
    });
    const blob=new Blob(["\uFEFF"+CSV.to(rows)],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='observations_'+(state.classe||'classe')+'.csv'; a.click(); URL.revokeObjectURL(a.href);
  }
};

/* ===== UI ===== */
window.UI={
  enterApp(){document.getElementById('cover').classList.add('hidden');document.getElementById('appHeader').classList.remove('hidden');document.getElementById('appMain').classList.remove('hidden')},
  showCover(){document.getElementById('appHeader').classList.add('hidden');document.getElementById('appMain').classList.add('hidden');document.getElementById('cover').classList.remove('hidden')},
  init(){
    const csvCover=document.getElementById('csvInputCover'); if(csvCover) csvCover.addEventListener('change',Import.handleCsv);
    document.getElementById('className').textContent='Classe: '+state.classe;
    document.getElementById('quickSearch').addEventListener('input',UI.renderTable);
    document.getElementById('filterCategorie').addEventListener('change',UI.renderTable);
    document.getElementById('filterEtat').addEventListener('change',UI.renderTable);
    document.getElementById('resetFilters').addEventListener('click',()=>{
      document.getElementById('filterCategorie').value='';
      document.getElementById('filterEtat').value='';
      document.getElementById('quickSearch').value='';
      UI.renderTable();
    });
    document.getElementById('addStudentBtn').addEventListener('click',UI.promptAddStudent);
    document.getElementById('csvInput').addEventListener('change',Import.handleCsv);
    document.getElementById('exportObsCsv').addEventListener('click',Export.obsCsv);
    document.getElementById('printBtn').addEventListener('click',()=>print());
    document.getElementById('helpBtn').addEventListener('click',UI.showHelp);
    UI.renderTable(); UI.renderKpis(); UI.renderFeed();
  },
  refreshAll(){ UI.renderTable(); UI.renderKpis(); UI.renderFeed(); },
  renderFeed(){
    const box=document.getElementById('feedList'); box.innerHTML='';
    if(!(state.feed||[]).length){box.innerHTML='<div class="empty">Aucun message</div>';return}
    state.feed.forEach(m=>{
      const d=document.createElement('div'); d.className='card'; d.style.padding='8px 10px'; d.style.marginBottom='8px';
      d.innerHTML='<div style="font-size:12px;color:#6b7280">'+new Date(m.ts).toLocaleString('fr-FR')+' ‚Ä¢ '+m.author+'</div><div>'+escapeHtml(m.text)+'</div>';
      box.appendChild(d);
    });
  },
  renderKpis(){
    document.getElementById('kpiEleves').textContent=state.eleves.length;
    const tot=Object.values(state.observations).reduce((a,b)=>a+b.length,0); document.getElementById('kpiObs').textContent=tot;
    let att=0,ok=0; state.eleves.forEach(e=>{ if(statusFor(e.id)==='attention') att+=1; else ok+=1; });
    document.getElementById('kpiWarn').textContent=att; document.getElementById('kpiOk').textContent=ok;
    document.getElementById('counts').textContent=`${state.eleves.length} √©l√®ves ¬∑ ${tot} obs`;
    const all=Math.max(1,state.eleves.length);
    document.getElementById('barWarn').style.width=(att/all*100).toFixed(0)+'%';
    document.getElementById('barOk').style.width=(ok/all*100).toFixed(0)+'%';
  },
  renderTable(){
    const body=document.getElementById('studentsBody'); body.innerHTML='';
    let data=[...state.eleves];
    const q=document.getElementById('quickSearch').value.trim().toLowerCase();
    const cat=document.getElementById('filterCategorie').value;
    const etat=document.getElementById('filterEtat').value;
    if(q) data=data.filter(e=>(e.nom+' '+e.prenom).toLowerCase().includes(q));
    if(cat) data=data.filter(e=>(state.observations[e.id]||[]).some(o=>o.categorie===cat));
    if(etat) data=data.filter(e=>statusFor(e.id)===etat);
    data.sort((a,b)=> (a.nom||'').localeCompare(b.nom||'','fr',{sensitivity:'base'})||(a.prenom||'').localeCompare(b.prenom||'','fr',{sensitivity:'base'}));
    if(!data.length){
      const tr=document.createElement('tr'),td=document.createElement('td'); td.colSpan=6; td.className='empty'; td.textContent='Aucun r√©sultat';
      tr.appendChild(td); body.appendChild(tr); return;
    }
    data.forEach(e=>{
      const tr=document.createElement('tr'); tr.style.cursor='pointer'; tr.addEventListener('click',()=>UI.openDrawer(e.id));
      const sexe=e.sexe?('<span class="pill">'+e.sexe+'</span>'):'';
      tr.innerHTML='<td><b>'+(e.nom||'')+'</b></td><td>'+(e.prenom||'')+'</td><td>'+sexe+'</td><td>'+countObs(e.id)+'</td><td>'+(lastDateFor(e.id)||'-')+'</td><td>'+(statusFor(e.id)==='attention'?'<span class="pill att">‚ö†Ô∏è</span>':'<span class="pill ok">‚úÖ</span>')+'</td>';
      body.appendChild(tr);
    });
  },
  promptAddStudent(){
    const nom=prompt('Nom ?'); if(nom===null) return;
    const prenom=prompt('Pr√©nom ?'); if(prenom===null) return;
    const classe=prompt('Classe ? (ex: 3F)')||state.classe||''; const sexe=prompt('Sexe ? (F/M)')||'';
    const id=uid(); state.eleves.push({id,nom,prenom,classe,sexe,_ts:Date.now()}); state.classe=classe||state.classe; save();
    document.getElementById('className').textContent='Classe: '+state.classe;
    UI.refreshAll(); UI.enterApp();
  },
  openDrawer(id){
    currentId=id; const e=state.eleves.find(x=>x.id===id); if(!e) return;
    document.getElementById('drawerTitle').textContent=e.prenom+' '+e.nom;
    document.getElementById('drawerSub').textContent=(e.classe||'')+' ‚Ä¢ '+(e.sexe||'');
    document.getElementById('obsAuteur').value=''; document.getElementById('obsDate').value=new Date().toISOString().slice(0,10);
    document.getElementById('obsTexte').value=''; document.getElementById('obsCategorie').value='Travail'; document.getElementById('obsEtat').value='ok';
    UI.renderObsList(); document.getElementById('drawer').classList.remove('hidden');
  },
  closeDrawer(){document.getElementById('drawer').classList.add('hidden'); currentId=null},
  renderObsList(){
    const box=document.getElementById('obsList'); box.innerHTML='';
    const arr=state.observations[currentId]||[]; if(!arr.length){box.innerHTML='<div class="empty">Aucune observation</div>';return}
    arr.forEach((o,idx)=>{
      const d=document.createElement('div'); d.className='card'; d.style.padding='10px'; d.style.marginBottom='8px';
      d.innerHTML='<div style="font-size:12px;color:#6b7280">'+(o.etat==='attention'?'‚ö†Ô∏è':'‚úÖ')+' ‚Ä¢ '+o.categorie+' ‚Ä¢ '+new Date(o.ts).toLocaleString('fr-FR')+' ‚Ä¢ '+(o.auteur||'‚Äî')+'</div><div>'+escapeHtml(o.texte)+'</div><div style="margin-top:6px"><button class="btn" onclick="UI.deleteObs('+idx+')">Supprimer</button></div>';
      box.appendChild(d);
    });
  },
  addObservation(){
    if(!currentId) return;
    const texte=document.getElementById('obsTexte').value.trim(); if(!texte){alert('Merci de saisir un texte');return}
    const o={texte,categorie:document.getElementById('obsCategorie').value,etat:document.getElementById('obsEtat').value,auteur:document.getElementById('obsAuteur').value.trim(),date:document.getElementById('obsDate').value,ts:document.getElementById('obsDate').value?new Date(document.getElementById('obsDate').value+'T12:00:00').getTime():Date.now()};
    if(!state.observations[currentId]) state.observations[currentId]=[];
    state.observations[currentId].push(o); save();
    UI.renderObsList(); UI.refreshAll();
    document.getElementById('obsTexte').value='';
  },
  deleteObs(i){ if(!currentId) return; const arr=state.observations[currentId]||[]; arr.splice(i,1); save(); UI.renderObsList(); UI.refreshAll(); },
  deleteStudent(){
    if(!currentId) return; const e=state.eleves.find(x=>x.id===currentId); if(!e) return;
    if(!confirm('Supprimer '+e.prenom+' '+e.nom+' ?')) return;
    state.eleves=state.eleves.filter(x=>x.id!==currentId); delete state.observations[currentId]; save();
    UI.closeDrawer(); UI.refreshAll();
  },
  copyStudentReport(){
    if(!currentId) return; const e=state.eleves.find(x=>x.id===currentId); const arr=state.observations[currentId]||[];
    const L=['Bilan '+e.prenom+' '+e.nom+' ('+e.classe+')','']; arr.forEach(o=>L.push('['+o.categorie+' ‚Ä¢ '+(o.etat==='attention'?'‚ö†Ô∏è':'‚úÖ')+' ‚Ä¢ '+new Date(o.ts).toLocaleDateString('fr-FR')+' ‚Ä¢ '+(o.auteur||'‚Äî')+'] '+o.texte));
    navigator.clipboard.writeText(L.join('\\n')); alert('Bilan copi√©');
  },
  showHelp(){alert('1) Entrer ou D√©mo\\n2) Import CSV\\n3) Cliquer un √©l√®ve pour ajouter des observations\\n4) Export CSV ou Mail pour partager.')}
};

/* ===== TESTS ===== */
(function(){
  const name='[Tests EduTeam Lite v2]'; const ok=m=>console.log(name,'‚úÖ',m), ko=m=>console.warn(name,'‚ö†Ô∏è',m);
  try{
    (typeof window.UI==='object' && typeof UI.init==='function' && typeof UI.refreshAll==='function') ? ok('UI global') : ko('UI global');
    const t1='Nom,Pr√©nom\\n"\"Doe, Jr\"",John'.replace('\"','"'); // ensure quote is present
    const p1=CSV.parse('Nom,Pr√©nom\\n"Doe, Jr",John'); (p1.length===2 && p1[1][0]==='Doe, Jr' && p1[1][1]==='John') ? ok('CSV quotes') : ko('CSV quotes');
    const rows=[["A","B"],["x,y","z\\nq"]]; const back=CSV.parse(CSV.to(rows)); (back.length===3 && back[2][0]==='x,y' && back[2][1]==='z\\nq') ? ok('CSV round-trip') : ko('CSV round-trip');
    const statuses=['ok','attention','ok','ok','attention']; let a=0,o=0; statuses.forEach(s=>{if(s==='attention')a+=1; else o+=1}); (a===2 && o===3) ? ok('KPI') : ko('KPI');
  }catch(e){ console.error(name,'Exception',e) }
})();

/* ===== BOOT ===== */
document.addEventListener('DOMContentLoaded',()=>{ try{ UI.init(); } catch(e){ console.error('Init error',e) } });
</script>
</body>
</html>
